<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMINI 六爻股市预测系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&display=swap');
        
        body {
            background-color: #0a0a0a;
            color: #d4af37;
            font-family: 'Noto Serif SC', serif;
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #050505 100%);
        }

        .gua-line {
            height: 12px;
            transition: all 0.3s ease;
        }

        .yang-line {
            background: linear-gradient(90deg, #d4af37 0%, #f9e29a 50%, #d4af37 100%);
            width: 100%;
        }

        .yin-line {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background: transparent;
        }

        .yin-line::before, .yin-line::after {
            content: '';
            height: 100%;
            width: 45%;
            background: linear-gradient(90deg, #d4af37 0%, #f9e29a 50%, #d4af37 100%);
        }

        .moving-mark {
            color: #ff4500;
            font-weight: bold;
            margin-left: 10px;
        }

        .coin {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            font-weight: bold;
        }

        .cyber-border {
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.1);
        }

        @keyframes spinning {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1800deg); }
        }

        .coin-spin {
            animation: spinning 0.6s ease-out;
        }

        #settings-modal {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <div class="max-w-4xl mx-auto">
        <!-- Navigation/Header -->
        <div class="flex justify-between items-start mb-4">
            <button onclick="toggleSettings()" class="p-2 text-yellow-800 hover:text-yellow-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
            <div class="text-right">
                <p id="key-status" class="text-[10px] uppercase tracking-widest text-red-800">API Key 未配置</p>
            </div>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-4xl font-black tracking-widest mb-2">六爻股市预测系统</h1>
            <p class="text-yellow-600 text-sm uppercase tracking-widest">Financial Divination Terminal</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left: Casting -->
            <div class="cyber-border bg-black/40 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">起卦 (Cast)</h2>
                    <span id="step-count" class="text-xs bg-yellow-900/30 px-3 py-1 rounded">第 0/6 爻</span>
                </div>

                <div class="mb-6">
                    <input type="text" id="stock-name" placeholder="输入预测目标 (如: NVDA)" class="w-full bg-black border border-yellow-900/50 p-3 text-yellow-500 focus:outline-none focus:border-yellow-500 rounded">
                </div>

                <div class="flex justify-around mb-8 py-6 bg-gray-900/20 rounded-xl">
                    <div id="coin-1" class="coin">?</div>
                    <div id="coin-2" class="coin">?</div>
                    <div id="coin-3" class="coin">?</div>
                </div>

                <button id="btn-toss" onclick="tossCoins()" class="w-full py-4 bg-yellow-600 text-black font-black rounded-lg hover:bg-yellow-500 transition-all active:scale-95">
                    摇卦 (CAST)
                </button>
                
                <div id="gua-display" class="mt-8 space-y-3 flex flex-col-reverse min-h-[150px]">
                    <!-- Gua lines -->
                </div>
            </div>

            <!-- Right: Result -->
            <div class="flex flex-col gap-6">
                <div class="cyber-border bg-black/40 p-6 rounded-lg flex-grow">
                    <h2 class="text-xl font-bold mb-4">卦象解析</h2>
                    <div id="analysis-content" class="text-gray-400 text-sm space-y-4">
                        <p class="italic">待六爻起毕...</p>
                    </div>
                    
                    <div id="ai-section" class="hidden mt-6 pt-6 border-t border-yellow-900/30">
                        <button id="btn-ai" onclick="askGemini()" class="w-full py-3 bg-cyan-900/30 text-cyan-400 border border-cyan-500/50 rounded flex items-center justify-center gap-2 hover:bg-cyan-800/40">
                            Gemini Pro 深度辅助解卦
                        </button>
                    </div>
                </div>

                <div class="text-[10px] text-yellow-900 text-center italic">
                    * 股市有风险，预测仅供参考 *
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="max-w-md w-full cyber-border bg-black p-8 rounded-lg">
            <h3 class="text-xl font-bold mb-4">系统配置</h3>
            <p class="text-xs text-gray-500 mb-6">请输入您的 Gemini API Key。该 Key 将仅保存在您的浏览器本地缓存中。</p>
            <input type="password" id="api-key-input" placeholder="输入 Gemini API Key" class="w-full bg-gray-900 border border-gray-700 p-3 mb-6 text-white rounded">
            <div class="flex gap-4">
                <button onclick="saveSettings()" class="flex-grow py-3 bg-yellow-600 text-black font-bold rounded">保存 (SAVE)</button>
                <button onclick="toggleSettings()" class="px-6 py-3 border border-gray-700 rounded">取消</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let guaData = [];
        let config = { apiKey: localStorage.getItem('gemini_api_key') || "" };

        function updateKeyStatus() {
            const status = document.getElementById('key-status');
            if (config.apiKey) {
                status.innerText = "API Key 已就绪";
                status.className = "text-[10px] uppercase tracking-widest text-green-700";
            } else {
                status.innerText = "API Key 未配置";
                status.className = "text-[10px] uppercase tracking-widest text-red-800";
            }
        }
        updateKeyStatus();

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('api-key-input').value = config.apiKey;
            }
        }

        function saveSettings() {
            const val = document.getElementById('api-key-input').value;
            config.apiKey = val;
            localStorage.setItem('gemini_api_key', val);
            updateKeyStatus();
            toggleSettings();
        }

        function tossCoins() {
            if (currentStep >= 6) return;
            const btn = document.getElementById('btn-toss');
            btn.disabled = true;
            
            const coins = [document.getElementById('coin-1'), document.getElementById('coin-2'), document.getElementById('coin-3')];
            let results = [];

            coins.forEach(c => c.classList.add('coin-spin'));

            setTimeout(() => {
                coins.forEach(c => {
                    c.classList.remove('coin-spin');
                    const res = Math.random() > 0.5 ? 3 : 2;
                    results.push(res);
                    c.innerText = res === 3 ? "阳" : "阴";
                    c.style.color = res === 3 ? "#d4af37" : "#555";
                });
                const sum = results.reduce((a, b) => a + b, 0);
                processLine(sum);
                btn.disabled = false;
            }, 600);
        }

        function processLine(sum) {
            currentStep++;
            document.getElementById('step-count').innerText = `第 ${currentStep}/6 爻`;
            
            let type = (sum === 7 || sum === 9) ? "yang" : "yin";
            let moving = (sum === 6 || sum === 9);
            
            guaData.push({ sum, type, moving });
            renderGua();
            if (currentStep === 6) finishGua();
        }

        function renderGua() {
            const display = document.getElementById('gua-display');
            display.innerHTML = "";
            guaData.forEach(line => {
                const row = document.createElement('div');
                row.className = "flex items-center";
                const lineInner = document.createElement('div');
                lineInner.className = `gua-line ${line.type === 'yang' ? 'yang-line' : 'yin-line'} flex-grow rounded`;
                row.appendChild(lineInner);
                if (line.moving) {
                    const m = document.createElement('span');
                    m.className = "moving-mark";
                    m.innerText = line.sum === 9 ? "○" : "×";
                    row.appendChild(m);
                }
                display.appendChild(row);
            });
        }

        function finishGua() {
            document.getElementById('btn-toss').innerText = "起卦完成";
            document.getElementById('btn-toss').disabled = true;
            document.getElementById('ai-section').classList.remove('hidden');
            document.getElementById('analysis-content').innerHTML = `
                <div class="p-4 bg-yellow-900/10 rounded border border-yellow-900/30">
                    <p class="text-yellow-500 font-bold mb-2">排盘完成</p>
                    <p class="text-xs">当前卦象记录完毕。由于六爻断卦涉及复杂的干支、月令、旬空等逻辑，建议点击下方按钮，由 Gemini Pro 结合当前时空背景进行全量推演。</p>
                </div>
            `;
        }

        async function askGemini() {
            if (!config.apiKey) {
                alert("请先点击左上角齿轮图标，配置您的 Gemini API Key");
                toggleSettings();
                return;
            }

            const stock = document.getElementById('stock-name').value || "未知标的";
            const btn = document.getElementById('btn-ai');
            const content = document.getElementById('analysis-content');
            
            btn.disabled = true;
            btn.innerText = "正在向星辰请求启示...";

            const prompt = `你是一位精通周易六爻的金融分析师。用户预测标的：${stock}。起卦记录（从初爻至上爻）：${JSON.stringify(guaData)}。请分析：1.卦象象义 2.财爻/子孙爻/兄弟爻强弱 3.针对股市的涨跌预测和操作建议。`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${config.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "解析失败，请检查 API Key 是否有效。";
                
                content.innerHTML += `
                    <div class="mt-4 p-4 bg-cyan-950/20 border-l border-cyan-500 text-cyan-100 text-xs whitespace-pre-wrap leading-relaxed">
                        <strong class="block text-cyan-400 mb-2">GEMINI 深度解读：</strong>
                        ${text}
                    </div>
                `;
                btn.innerText = "解卦完成";
            } catch (e) {
                alert("调用失败，请检查网络或 API Key");
                btn.disabled = false;
                btn.innerText = "重新尝试解卦";
            }
        }
    </script>
</body>
</html>